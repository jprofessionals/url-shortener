name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to promote (leave empty for latest successful)'
        required: false
        type: string

env:
  AWS_REGION: eu-north-1

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Get latest successful run ID
        if: inputs.run_id == ''
        id: get-run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID=$(gh run list --workflow=deploy-lambdas.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Using artifacts from run: $RUN_ID"

      - name: Download artifacts from previous run
        uses: actions/download-artifact@v4
        with:
          name: lambda-artifacts
          path: infra/sam/artifacts/
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id || steps.get-run.outputs.run_id }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Deploy to prod
        working-directory: infra/sam
        run: |
          sam deploy \
            --stack-name url-shortener-prod \
            --template-file template.yaml \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              StageName=prod \
              AllowedDomain=${{ vars.ALLOWED_DOMAIN }} \
              GoogleOAuthClientId=${{ vars.GOOGLE_OAUTH_CLIENT_ID }} \
              ShortlinkDomain=${{ vars.SHORTLINK_DOMAIN }} \
              CorsAllowOrigin=${{ vars.CORS_ALLOW_ORIGIN }} \
              CustomDomainName=${{ vars.CUSTOM_DOMAIN_NAME }} \
              CustomDomainCertificateArn=${{ vars.CUSTOM_DOMAIN_CERT_ARN }} \
              AdminEmails=${{ vars.ADMIN_EMAILS }}
